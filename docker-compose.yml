version: '2'
services:
  idp.tutorial.stack-dev.cirrusidentity.com:
    build: build
    volumes:
      - ./simplesamlphp:/code
      - ./totp2fa:/plugin
      - ./idp:/conf
    working_dir: /code
    environment:
      - SIMPLESAMLPHP_CONFIG_DIR=/conf/
    links:
      - mysql

  proxy.tutorial.stack-dev.cirrusidentity.com:
    build: build
    volumes:
      - ./simplesamlphp:/code
      - ./totp2fa:/plugin
      - ./proxy:/conf
    working_dir: /code
    environment:
      - SIMPLESAMLPHP_CONFIG_DIR=/conf/

  sp1.tutorial.stack-dev.cirrusidentity.com:
    build: build
    hostname: sp1
    volumes:
      - ./simplesamlphp:/code
      - ./totp2fa:/plugin
      - ./sp1:/conf
    working_dir: /code
    environment:
      - SIMPLESAMLPHP_CONFIG_DIR=/conf/
    command: apache2 -D FOREGROUND
    links:
      - redis

  sp2.tutorial.stack-dev.cirrusidentity.com:
    build: build
    volumes:
      - ./simplesamlphp:/code
      - ./totp2fa:/plugin
      - ./sp2:/conf
    working_dir: /code
    environment:
      - SIMPLESAMLPHP_CONFIG_DIR=/conf/
    links:
      - memcached

  docs.tutorial.stack-dev.cirrusidentity.com:
    build: build
    volumes:
      - ./phpdocs:/code/www
    working_dir: /code
    command: apache2 -D FOREGROUND

  memcached:
    image: memcached

  mysql:
    image: mysql
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_DATABASE: sessions
      MYSQL_USER: dbuser
      MYSQL_PASSWORD: dbpassword
      MYSQL_ROOT_PASSWORD: rootpassword

  redis:
    image: redis

  gencert:
    image: cfssl/cfssl
    volumes:
      - .:/work
    working_dir: /work
    entrypoint: /bin/bash
    command:
      - ./ca/generate.sh

  gendocs:
    image: phpdoc/phpdoc
    volumes:
      - .:/data
    command:
      - run -t ./phpdocs -d ./simplesamlphp
    

  nginx:
    image: nginx:stable
    links:
      - docs.tutorial.stack-dev.cirrusidentity.com
      - idp.tutorial.stack-dev.cirrusidentity.com
      - proxy.tutorial.stack-dev.cirrusidentity.com
      - sp1.tutorial.stack-dev.cirrusidentity.com
      - sp2.tutorial.stack-dev.cirrusidentity.com
    volumes:
      - ./nginx:/etc/nginx:ro
    ports:
      - '80:80'
      - '443:443'
